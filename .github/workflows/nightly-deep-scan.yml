name: Nightly Deep Security Scan

on:
  push:
    branches:
      - staging  # Required gate before staging can merge to main
  schedule:
    - cron: "30 1 * * *"  # 5:30 PM PST (1:30 AM UTC next day) - for testing
    # - cron: "0 2 * * *"  # 2 AM daily - uncomment for production
  workflow_dispatch:  # Manual trigger for testing

jobs:
  deep-security-scan:
    name: Nightly Deep Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 150  # 2.5 hours max (30 min security + 2 hours fuzzing)
    permissions:
      contents: read
      security-events: write
      packages: write        # For pushing to GitHub Container Registry
      deployments: write     # For fuzzing ephemeral environment
      issues: write          # For ZAP to auto-create issues for findings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # ========== TRIVY SCANNING (ACTIVE) ==========

      # Set up Docker Buildx for efficient builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build and push Docker image to ghcr.io
      - name: Build and push Docker image
        uses: docker/build-push-action@v6.19.1
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Scan the built Docker image for vulnerabilities
      - name: Trivy - Scan Docker Image
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true  # Generate SARIF even on findings, mark step as failed
        with:
          scan-type: 'image'
          image-ref: 'ghcr.io/${{ github.repository }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on Critical/High vulnerabilities
          scanners: 'vuln'  # Vulnerability scanning only (os + library packages)

      - name: Upload Trivy Image Scan SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image-results.sarif
          category: trivy-image

      # Scan filesystem for IaC misconfigurations, secrets, and license issues
      - name: Trivy - Scan Repository (IaC, Secrets, Config)
        if: always()  # Run even if image scan fails
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true  # Don't stop workflow on config issues
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Report findings but don't fail (config scan is advisory)
          scanners: 'config,secret,license'

      - name: Upload Trivy Filesystem Scan SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-fs-results.sarif
          category: trivy-fs

      # Generate human-readable reports (always run for audit trail)
      - name: Trivy - Generate HTML Report
        if: always()  # Run even if scans fail, to document what was found
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'image'
          image-ref: 'ghcr.io/${{ github.repository }}:${{ github.sha }}'
          format: 'template'
          template: '@$HOME/.local/bin/trivy-bin/contrib/html.tpl'
          output: 'trivy-report.html'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln'
          exit-code: '0'  # Don't fail workflow again (already failed in main scan)

      - name: Upload Trivy HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-report
          path: trivy-report.html
          retention-days: 30  # Keep reports for 30 days

      # ========== OTHER CHECKS (COMMENTED OUT) ==========

      # # Deep SAST - Full Semgrep rulesets (fail on ERROR severity only)
      # - name: SAST (Semgrep - Comprehensive)
      #   run: |
      #     semgrep \
      #       --config p/r2c-security-audit \
      #       --config p/secrets \
      #       --config p/python \
      #       --config p/docker \
      #       --severity ERROR \
      #       --sarif --output semgrep-deep.sarif \
      #       --quiet --metrics=off

      # - name: Upload Semgrep SARIF
      #   if: always()
      #   uses: github/codeql-action/upload-sarif@v4
      #   with:
      #     sarif_file: semgrep-deep.sarif
      #     category: semgrep-deep

      # # Python security - High/Medium severity (fail on high only)
      # - name: Python Security (Bandit - High Severity)
      #   run: bandit -r src/ --severity-level high -f sarif -o bandit-deep.sarif

      # - name: Upload Bandit SARIF
      #   if: always()
      #   uses: github/codeql-action/upload-sarif@v4
      #   with:
      #     sarif_file: bandit-deep.sarif
      #     category: bandit-deep

      # # Comprehensive dependency scanning (fail on CVSS 7.0+ / high/critical)
      # - name: SCA (OWASP Dependency-Check - CVSS 7.0+)
      #   if: always()
      #   uses: dependency-check/Dependency-Check_Action@main
      #   with:
      #     project: 'rag-engine'
      #     path: '.'
      #     format: 'HTML'
      #     args: >
      #       --enableRetired
      #       --failOnCVSS 7

      # - name: Upload OWASP Dependency-Check report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dependency-check-report
      #     path: reports

      # DAST - OWASP ZAP scan against staging (fail on high/medium alerts)
      - name: OWASP ZAP Deep Scan (High Alerts)
        if: always()  # Run even if Trivy scans fail
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'https://rag-engine-staging.fly.dev'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -n -l PASS'
          fail_action: true
          allow_issue_writing: true
          issue_title: 'OWASP ZAP Deep Scan – Nightly'

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-deep-scan-report
          path: |
            report_html.html
            report_md.md
            report_json.json

      # Final check - fail workflow if image vulnerabilities found
      - name: Check Trivy Results
        if: always()
        run: |
          if [ -f trivy-image-results.sarif ]; then
            # Count vulnerabilities in SARIF
            vuln_count=$(jq '.runs[0].results | length' trivy-image-results.sarif 2>/dev/null || echo "0")
            echo "Image vulnerabilities found: $vuln_count"
            if [ "$vuln_count" -gt 0 ]; then
              echo "❌ CRITICAL/HIGH vulnerabilities detected in Docker image"
              echo "Review the Security tab for details"
              exit 1
            fi
          fi
          echo "✅ No critical vulnerabilities found"

      # FUTURE: Deep fuzzing against ephemeral environment (1-2 hours)
      # Planned implementation:
      # 1. Deploy ephemeral fuzzing environment (separate from staging/prod)
      # 2. Run comprehensive API fuzzing (REST, GraphQL endpoints)
      # 3. Property-based testing with hypothesis/schemathesis
      # 4. Mutation-based fuzzing (AFL++, libFuzzer for Python C extensions)
      # 5. Collect crash reports, coverage data
      # 6. Upload fuzzing results as artifacts
      # 7. Tear down ephemeral environment
      # Tools: Schemathesis, hypothesis, AFL++, custom fuzzers
