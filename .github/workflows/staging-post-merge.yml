name: Staging Post-Merge Security

on:
  push:
    branches: [ staging ]

jobs:
  security-scan:
    name: Post-Merge Security Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      # Secret scanning (no Python needed)
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Python-based security tools
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Bandit security scan
        run: bandit -r src/ --severity-level high -f json -o bandit-report.json
        continue-on-error: false

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Run Semgrep
        if: always()
        run: |
          semgrep \
            --config p/ci \
            --sarif --output semgrep.sarif \
            --quiet --metrics=off
        continue-on-error: true

      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      - name: Run pip-audit (Fast SCA)
        if: always()
        run: pip-audit --desc

      - name: Run Ruff linter
        if: always()
        run: ruff check src/
